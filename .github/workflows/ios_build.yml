name: Build iOS App

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Autotools (autoconf, automake, libtool)
      run: |
        brew update
        brew install autoconf automake libtool pkg-config

    - name: Setup Python & deps
      run: |
        brew install python3
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install cython sh pbxproj cookiecutter

    - name: Clone kivy-ios repository
      run: |
        source venv/bin/activate
        git clone https://github.com/kivy/kivy-ios.git ios/kivy-ios

    - name: Fix toolchain.py permissions and validate shebang
  run: |
    if ! grep -q '^#!' ios/kivy-ios/toolchain.py; then
      echo '#!/usr/bin/env python3' | cat - ios/kivy-ios/toolchain.py > temp && mv temp ios/kivy-ios/toolchain.py
    fi
    chmod +x ios/kivy-ios/toolchain.py
      run: |
        chmod +x ios/kivy-ios/toolchain.py

    - name: Build toolchain
      run: |
        source venv/bin/activate
        cd ios/kivy-ios
        ./toolchain.py build python3 kivy

    - name: Create Xcode project (myapp-ios)
      run: |
        source venv/bin/activate
        cd ios/kivy-ios
        ./toolchain.py create ios myapp

    - name: Ensure myapp-ios Directory Exists
      run: |
        if [ ! -d "ios/kivy-ios/myapp-ios" ]; then
          echo "❌ خطأ: لم يتم إنشاء مجلد myapp-ios"
          exit 1
        fi
        echo "✅ تم إنشاء المجلد بنجاح"
        ls ios/kivy-ios/myapp-ios

    - name: Build with xcodebuild
      run: |
        cd ios/kivy-ios/myapp-ios
        xcodebuild -scheme myapp                    -configuration Release                    -sdk iphoneos                    CODE_SIGN_STYLE=Automatic                    DEVELOPMENT_TEAM=${{ secrets.APPLE_DEV_TEAM }}                    BUILD_DIR=build

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-app
        path: ios/kivy-ios/myapp-ios/build/Release-iphoneos/*.ipa
