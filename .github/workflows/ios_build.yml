name: Build iOS App

on: [push,pull_request]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python & deps
        run: |
          brew install python3
          python3 -m venv venv; source venv/bin/activate
          pip install --upgrade pip cython
      - name: Clone kivy-ios
        run: |
          git clone https://github.com/kivy/kivy-ios.git ios/kivy-ios
          cd ios/kivy-ios; source venv/bin/activate
          ./toolchain.py build python3 kivy
      - name: Create Xcode project
        run: |
          cd ios/kivy-ios; source venv/bin/activate
          ./toolchain.py create ios myapp com.example.parchisi
      - name: Copy sources
        run: rsync -a --delete ./ ./ios/kivy-ios/myapp-ios/myapp/
      - name: Build with xcodebuild
        run: |
          cd ios/kivy-ios/myapp-ios
          xcodebuild -scheme myapp -configuration Release -sdk iphoneos \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_DEV_TEAM }} \
            BUILD_DIR=build
      - name: Upload .ipa
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: ios/kivy-ios/myapp-ios/build/Release-iphoneos/*.ipa
