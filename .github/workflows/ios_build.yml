name: Build iOS App

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python & deps
      run: |
        brew install python3
        python3 --version
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip cython

    - name: Clone kivy-ios & build toolchain
      run: |
        source venv/bin/activate
        git clone https://github.com/kivy/kivy-ios.git ios/kivy-ios
        cd ios/kivy-ios
        chmod +x toolchain.py               # ← هذه السطر أُضيف
        ./toolchain.py build python3 kivy

    - name: Create Xcode project
      run: |
        source venv/bin/activate
        cd ios/kivy-ios
        ./toolchain.py create ios myapp com.example.parchisi

    - name: Copy app sources into Xcode project
      run: |
        rsync -a --delete ./ ./ios/kivy-ios/myapp-ios/myapp/

    - name: Build with xcodebuild
      run: |
        cd ios/kivy-ios/myapp-ios
        xcodebuild -scheme myapp \
                   -configuration Release \
                   -sdk iphoneos \
                   CODE_SIGN_STYLE=Automatic \
                   DEVELOPMENT_TEAM=${{ secrets.APPLE_DEV_TEAM }} \
                   BUILD_DIR=build

    - name: Archive .ipa artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app
        path: ios/kivy-ios/myapp-ios/build/Release-iphoneos/*.ipa
